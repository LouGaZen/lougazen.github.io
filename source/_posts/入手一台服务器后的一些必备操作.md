---
title: 入手一台服务器后的一些必备操作
date: 2019-12-23 16:17:24
tags:
---

## 序

无意中看到腾讯云服务器的[活动](https://cloud.tencent.com/act/campus?fromSource=gwzcw.1293314.1293314.1293314&cps_key=db0b88ca8f49ff0684eddea9ae6bb50b)~~（Pony麻烦结一下广告费谢谢）~~，趁着现在还不够25岁赶紧续了3次每次最多续1年

![Pony Ma亏得都要坐公交了](https://i.loli.net/2019/12/23/dAZz8sf3TKNxjkY.png)

## 修改root密码

拿到服务器第一步就是把默认那个又长又难记的密码改掉

在命令行执行`passwd`

![passwd](https://i.loli.net/2019/12/23/ZJFX53jydVRfSxc.png)

修改成功后记得新开个tab测试新密码能否登陆再退出当前会话

## 配置服务器免密登陆ssh-keygen

先查看本机有没有生成过ssh的公钥和私钥

```bash
cd ~/.ssh
ls -al
```

![公钥和私钥](https://i.loli.net/2019/12/24/ATaymv9Re6NQ4gB.png)

红框中的两个文件分别存放着私钥和公钥，如果没有这两个文件就按以下步骤来

执行`ssh-keygen`然后按三下回车

![ssh-keygen](https://i.loli.net/2019/12/24/BCjFrIUNmEKqw7o.png)

现在再去查看就有公钥的信息了

![id_rsa.pub](https://i.loli.net/2019/12/24/Q9Jc2EhPaGAkgbI.png)

然后把这段公钥上传到目标服务器的`~/.ssh/authorized_keys`文件当中

![authorized_keys](https://i.loli.net/2019/12/24/K64XikdOT1CBmQ5.png)

测试一下，现在可以不用密码顺利登陆进来了

![免密登陆](https://i.loli.net/2019/12/24/W3XUaY7IlskCTiy.png)

！！！注意：万一电脑丢失记得上服务器把该机器的公钥删掉

## 防火墙

服务器到手的时候自带了firewalld但是并没有启动，使用`firewall-cmd --state`命令可以查看firewall的运行状态

![firewall-cmd --state](https://i.loli.net/2019/12/24/SCoQvKqa1sgHDGJ.png)

```bash
systemctl enable firewalld # 启用自动启动
systemctl start firewalld # 启动
```

成功的话再次查看状态会显示running

把常用的服务和端口加入允许列表
```bash
firewall-cmd --permanent --zone=public --add-service=http
firewall-cmd --permanent --zone=public --add-service=https
firewall-cmd --reload
```


## 修改ssh默认端口

~~稍有常识的人~~ 众所周知ssh默认端口是22，如果不加以修改很容易被人攻击

![一夜过后被尝试889次登录](https://i.loli.net/2019/12/24/32Xz8Ujdotqrx5F.png)

（题外话使用`lastb`命令可以查看尝试登录的客户端信息，如果信息太多则`lastb > fail.log`重定向到本地文件再查看）

ssh端口的配置存放在`/etc/ssh/sshd_config`中，直接在`# Port 22`下一行添加

```shell script
Port 22
Port （你目标的端口）
```

![sshd_config](https://i.loli.net/2019/12/24/ZbrtGuv4PpnTKcg.png)

加上22端口是防止现在的连接失效，万一你添加的端口被防火墙屏蔽的那就gg了

然后再添加个防火墙允许规则

```bash
firewall-cmd --zone=public --add-port=（你目标的端口）/tcp --permanent
firewall-cmd --reload
```

重启ssh服务

```bash
systemctl restart sshd.service
```

不要关闭当前连接，新开个tab尝试能否连接成功，成功后再去把22端口删掉

端口修改后跟ssh相关的命令要带端口参数

```bash
ssh root@xxx.xx -p 123
sftp -P 123 root@xxx.xx
scp -P 123 ......
```

## 安装docker

按照官方的[文档](https://docs.docker.com/install/linux/docker-ce/centos/)把下面命令执行一遍就行了

```bash
sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum install docker-ce docker-ce-cli containerd.io
systemctl enable docker
systemctl start docker
```

## 使用docker启动nginx

首先在srv目录创建文件夹，用于放置ssl证书及nginx配置文件

```bash
mkdir -p /srv/nginx-data/conf/cert
```

把申请到的证书放在`/srv/nginx-data/conf/cert`目录下

在`/srv/nginx-data/conf`目录下创建一个`index.conf`的文件，内容如下

```markdown
# 使非www域名自动跳转到带www的域名
server {
    listen *:80;
    listen *:443 ssl http2;
    listen [::]:80;
    listen [::]:443 ssl http2;
    server_name 自己的域名;

    ssl_certificate SSL证书;
    ssl_certificate_key SSL证书;
    return 301 https://www.自己的域名$request_uri;
}

# 使http自动跳转到https
server {
    listen *:80;
    listen [::]:80;
    server_name www.自己的域名;
    return 301 https://www.自己的域名$request_uri;
}

server {
    listen *:443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.自己的域名;
    ssl_certificate SSL证书;
    ssl_certificate_key SSL证书;

    #charset koi8-r;
    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}
```

完成后执行以下命令启动docker版nginx

```bash
docker run -d --restart=always --name nginx -v /srv/nginx-data/conf:/etc/nginx/conf.d:ro -p 80:80 -p 443:443 nginx
```

其中一些参数的含义如下：

* `-d`代表后台运行
* `--restart=always`代表docker启动的时候该container也一起启动
* `-name`给该容器命名方便管理
* `-v`映射目录，格式`host目录:container目录(:ro)`，ro代表只读（read-only）
* `-p`开放指定端口，格式`host端口:container端口`

如果要修改nginx的配置文件，一般都要执行`nginx -t`测试和`nginx -s reload`来使生效，而在docker下就要执行

```bash
docker exec nginx /usr/sbin/nginx -t
docker exec nginx /usr/sbin/nginx -s reload
```

## 鸣谢

> [4.3 服务器上的 Git - 生成 SSH 公钥](https://git-scm.com/book/zh/v2/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84-Git-%E7%94%9F%E6%88%90-SSH-%E5%85%AC%E9%92%A5#r_generate_ssh_key)
> [firewall-cmd](https://wangchujiang.com/linux-command/c/firewall-cmd.html)
> [Centos7 修改SSH 端口](https://www.jianshu.com/p/c18d5347c9b6)
> [Get Docker Engine - Community for CentOS](https://docs.docker.com/install/linux/docker-ce/centos/)
